<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Elevator Frontend</title>
    <script src="js/earcut.min.js"></script>
    <script src="babylon.js"></script>
    <script src="js/babylonjs.loaders.js"></script>
    <script src="js/babylon.gui.min.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
      html,body { width:100%; height:100%; margin:0; padding:0; overflow:hidden; }
      #renderCanvas { width:100%; height:100%; touch-action:none; display:block; }
    </style>
  </head>
  <body>  
    <canvas id="renderCanvas"></canvas>
    <script>
    (function(){
      const SOCKET_URL = "http://localhost:8080";
      const ELEVATOR_ID = "ELEV-001";
      const FLOORS = 5;
      const FLOOR_HEIGHT = 2.0;

      const socket = io(SOCKET_URL);
      socket.on('connect', ()=>{ console.log('socket connected'); socket.emit('joinElevator', ELEVATOR_ID); });
      let lastTelemetry = null;
      let desiredTargetFloor = null;

      socket.on('state', (s) => {
        console.log('WS state', s);
        if (typeof s.positionY === 'number') lastTelemetry = lastTelemetry || {}; lastTelemetry.positionY = s.positionY;
        if (typeof s.targetFloor === 'number') desiredTargetFloor = s.targetFloor;
        else if (s.targetFloor === null) desiredTargetFloor = null;
      });
      socket.on('telemetry', (t)=> { lastTelemetry = t; });

      function sendMoveTo(floor) { socket.emit('command', { elevatorId: ELEVATOR_ID, type: 'moveToFloor', params: { floor } }); }

      const canvas = document.getElementById('renderCanvas');
      const engine = new BABYLON.Engine(canvas, true);
      window.addEventListener('resize', ()=> engine.resize());

      let scene = new BABYLON.Scene(engine);
      scene.clearColor = new BABYLON.Color3(0.7,0.7,0.8);
      const camera = new BABYLON.ArcRotateCamera('cam', -Math.PI/2, Math.PI/3, 18, new BABYLON.Vector3(0,3,0), scene);
      camera.attachControl(canvas, true);
      const hemi = new BABYLON.HemisphericLight('h', new BABYLON.Vector3(0,1,0), scene);

      // floor slabs
      for (let i=0;i<FLOORS;i++){
        const slab = BABYLON.MeshBuilder.CreateBox('slab'+i, {height:0.05, width:6, depth:2}, scene);
        slab.position = new BABYLON.Vector3(0, i*FLOOR_HEIGHT - 0.05, 0);
      }

      // runtime nodes
      let lift = null;
      let doorLeft = null, doorRight = null;
      let liftLoaded = false;

      // try load glbs, fall back to primitives if not present
      BABYLON.SceneLoader.ImportMesh("", "scenes/", "lift_model.glb", scene, function(meshes){
        if (meshes && meshes.length) {
          lift = meshes[0];
          lift.scaling = new BABYLON.Vector3(2,2,2);
          lift.position.y = 0;
          liftLoaded = true;
            doorLeft = scene.getNodeByName("Object_84");
     doorRight = scene.getNodeByName("Object_86");
     doorLeft.dispose(); 
     doorRight.dispose(); 
      door.setParent(lift);
        } else {
       //   createFallbackLift();
        }
      }, null, function(err){
        console.warn('lift_model.glb load failed, using fallback.', err);
        //if (!liftLoaded) createFallbackLift();
      });

      BABYLON.SceneLoader.ImportMesh("", "scenes/", "lift_door_.glb", scene, function(meshes){
        door = meshes[0]
        door.scaling = new BABYLON.Vector3(2,2,2)
        if (meshes && meshes.length) {
          doorLeft = scene.getNodeByName("right-door_Cube.001_primitive0") || meshes[0];
          doorRight = scene.getNodeByName("right-door_Cube.001_primitive1") || meshes[1] || meshes[0];
          if (doorLeft) doorLeft.position.x = 0;
          if (doorRight) doorRight.position.x = 0;
        } else {
          //createFallbackDoors();
        }
      }, null, function(err){
        console.warn('lift_door_.glb load failed, using fallback.', err);
       // if (!doorLeft || !doorRight) createFallbackDoors();
      });

    //   function createFallbackLift() {
    //     lift = BABYLON.MeshBuilder.CreateBox('liftFallback', { height:2.2, width:2.2, depth:1.8 }, scene);
    //     lift.position = new BABYLON.Vector3(0,0,0);
    //     lift.material = new BABYLON.StandardMaterial('mat', scene);
    //     lift.material.diffuseColor = new BABYLON.Color3(0.2,0.4,0.9);
    //   }

    //   function createFallbackDoors() {
    //     doorLeft = BABYLON.MeshBuilder.CreateBox('doorL', {height:2, width:0.2, depth:1.9}, scene);
    //     doorRight = BABYLON.MeshBuilder.CreateBox('doorR', {height:2, width:0.2, depth:1.9}, scene);
    //     doorLeft.position = new BABYLON.Vector3(0.55,0,0);
    //     doorRight.position = new BABYLON.Vector3(-0.55,0,0);
    //     doorLeft.material = doorRight.material = new BABYLON.StandardMaterial('dmat', scene);
    //     doorLeft.material.diffuseColor = new BABYLON.Color3(0.8,0.2,0.2);
    //   }

      // GUI floor buttons
      const gui = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI('ui');
      const floorLabels = ['G','1','2','3','4'];
      for (let i=0;i<FLOORS;i++){
        const btn = BABYLON.GUI.Button.CreateSimpleButton('b'+i, floorLabels[i]);
        btn.width="50px"; btn.height="40px"; btn.color="white"; btn.background="blue";
        btn.top = `${10 + i*50}px`; btn.left = "-600px"; btn.cornerRadius = 20;
        ((j)=>btn.onPointerClickObservable.add(()=> sendMoveTo(j)))(i);
        gui.addControl(btn);
      }

      // monitoring panel
      const panelUI = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI('mon');
      const panel = new BABYLON.GUI.StackPanel(); panel.width="260px"; panel.top="-220px"; panel.left="-120px"; panel.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_RIGHT; panel.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
      panelUI.addControl(panel);
      const header = new BABYLON.GUI.TextBlock(); header.text="Elevator Monitoring"; header.height="30px"; header.color="white"; header.fontSize=20; panel.addControl(header);
      const stateText = new BABYLON.GUI.TextBlock(); const tempText = new BABYLON.GUI.TextBlock(); const ropeText = new BABYLON.GUI.TextBlock(); const doorText = new BABYLON.GUI.TextBlock(); const posText = new BABYLON.GUI.TextBlock();
      [stateText,tempText,ropeText,doorText,posText].forEach(t=>{ t.height="25px"; t.color="white"; t.fontSize=14; panel.addControl(t); });

      let elevatorMoving = false;
let doorOpenAmount = 1; // 1 = fully open, 0 = fully closed
let liftMoving = false;
      scene.onBeforeRenderObservable.add(()=> {
        if (lift && lastTelemetry && typeof lastTelemetry.positionY === 'number') {
          const targetY = lastTelemetry.positionY;
          lift.position.y += (targetY - lift.position.y) * 0.3;
          let liftdoorLeft = scene.getNodeByName("right-door_Cube.001_primitive0");
            let rightdoorLeft = scene.getNodeByName("right-door_Cube.001_primitive1");
            liftdoorLeft.position.x = 80
            rightdoorLeft.position.x = -80
        } else if (lift && desiredTargetFloor !== null) {
          const target = desiredTargetFloor * FLOOR_HEIGHT;
          if (Math.abs(lift.position.y - target) > 0.02) {
            const d = target > lift.position.y ? 0.02 : -0.02;
            lift.position.y += d;
            
            console.log("ho")
          } else {
            lift.position.y = target;
            desiredTargetFloor = null;
            //  let liftdoorLeft = scene.getNodeByName("right-door_Cube.001_primitive0");
            // let rightdoorLeft = scene.getNodeByName("right-door_Cube.001_primitive1");
            // liftdoorLeft.position.x = 80
            // rightdoorLeft.position.x = -80
          }
        }

        const doorIsOpen = (lastTelemetry && lastTelemetry.doorStatus === 'open') || (!lastTelemetry && desiredTargetFloor === null);
        if (doorLeft && doorRight) {
              let liftdoorLeft = scene.getNodeByName("right-door_Cube.001_primitive0");
             let rightdoorLeft = scene.getNodeByName("right-door_Cube.001_primitive1");
            //  liftdoorLeft.position.x = 0
            // rightdoorLeft.position.x = 0
          const leftTarget = doorIsOpen ? 0 : 0.55;
          const rightTarget = doorIsOpen ? 0 : -0.55;
          liftdoorLeft.position.x += (leftTarget - doorLeft.position.x) * 0.2;
          rightdoorLeft.position.x += (rightTarget - doorRight.position.x) * 0.2;
        }

        stateText.text = `Elevator: ${ELEVATOR_ID}`;
        tempText.text = `Motor Temp: ${lastTelemetry ? (lastTelemetry.motorTemp||0).toFixed(1)+'Â°C' : 'N/A'}`;
        ropeText.text = `Rope: ${lastTelemetry ? (lastTelemetry.ropeTension||0).toFixed(1)+'N' : 'N/A'}`;
        doorText.text = `Door: ${lastTelemetry ? (lastTelemetry.doorStatus || '-') : '-'}`;
        posText.text = `Pos: ${lastTelemetry ? (lastTelemetry.positionY||0).toFixed(2)+' m' : (lift ? lift.position.y.toFixed(2)+' m' : 'N/A')}`;
     
    });

      engine.runRenderLoop(()=> { if (scene) scene.render(); });

      // keyboard shortcuts: 0..4
      window.addEventListener('keydown', (ev)=> {
        if (ev.key === '0') sendMoveTo(0);
        if (/^[1-4]$/.test(ev.key)) sendMoveTo(parseInt(ev.key,10));
      });

      window.__elevator = { socket, lastTelemetry };
    })();
    </script>
  </body>
</html>
